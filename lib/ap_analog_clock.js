/**
 * Analog clock.
 * @constructor ApAnalogClock
 */

"use strict";

const React = require('react'),
      ReactDOM = require('react-dom'),
      classnames = require('classnames'),
      ApClock = require('./ap_clock'),
      PureRenderMixin = require('react-addons-pure-render-mixin'),
      chopcal = require('chopcal'),
      numcal = require('numcal'),
      types = React.PropTypes,
      ApAnalogClockHand = require('./ap_analog_clock_hand'),
      ApAnalogClockLetter = require('./ap_analog_clock_letter');

/** @lends ApAnalogClock */
let ApAnalogClock = React.createClass({
    displayName: 'ApAnalogClock',

    //--------------------
    // Specs
    //--------------------

    propTypes: {
        boardLetters: types.array
    },

    mixins: [PureRenderMixin],

    statics: {
        _angleForValue: function (value, max) {
            let rate = value % max / max;
            return chopcal.round(rate * 360, 0.1);
        },
        hourHandAngle: function (date) {
            let hours = date.getHours();
            return ApAnalogClock._angleForValue(hours, 12);
        },
        minuteHandAngle: function (date) {
            let minutes = date.getMinutes();
            return ApAnalogClock._angleForValue(minutes, 60);
        },
        secondHandAngle: function (date) {
            let seconds = date.getSeconds();
            return ApAnalogClock._angleForValue(seconds, 60);
        },
        letterAngle: function (i, count) {
            return ApAnalogClock._angleForValue(i, count);
        }
    },

    getInitialState: function () {
        return {
            hour: 0,
            minute: 0,
            second: 0,
            size: 256
        };
    },

    getDefaultProps: function () {
        return {
            boardLetters: '12,1,2,3,4,5,6,7,8,9,10,11'.split(',')
        };
    },

    render: function () {
        let s = this,
            state = s.state,
            props = s.props;

        let letters = props.boardLetters.map((letter, i, letters) => {
            let angle = ApAnalogClock.letterAngle(i, letters.length);
            return React.createElement(ApAnalogClockLetter, { key: "ap-analog-letter-" + i,
                letter: letter,
                angle: angle });
        });

        let size = state.size;

        let boardStyle = {
            width: size,
            height: size
        };

        let screwSize = 9;

        return React.createElement(
            ApClock,
            { className: classnames("ap-analog-clock", props.className) },
            React.createElement(
                'div',
                { className: 'ap-analog-clock-board', style: boardStyle },
                React.createElement(
                    'div',
                    { className: 'ap-analog-clock-board-inner' },
                    React.createElement(ApAnalogClockHand, { className: 'ap-analog-clock-hand-hour', width: 4, heightRate: 0.8,
                        angle: state.hour }),
                    React.createElement(ApAnalogClockHand, { className: 'ap-analog-clock-hand-minute', width: 4, heightRate: 0.95,
                        angle: state.minute }),
                    React.createElement(ApAnalogClockHand, { className: 'ap-analog-clock-hand-second', width: 2, heightRate: 1,
                        angle: state.second })
                ),
                React.createElement(
                    'div',
                    null,
                    letters
                ),
                React.createElement(
                    'div',
                    { className: 'ap-analog-clock-screw-container' },
                    React.createElement('div', { className: 'ap-analog-clock-screw',
                        style: { width: screwSize, height: screwSize, bottom: -screwSize / 2 },
                        ref: 'screw' })
                )
            )
        );
    },

    //--------------------
    // Lifecycle
    //--------------------

    componentWillMount: function () {
        let s = this;
        s._looping = true;
    },

    componentDidMount: function () {
        let s = this,
            props = s.props;

        function _loop() {
            if (!s._looping) {
                return;
            }
            let now = new Date();
            s.setState({
                hour: ApAnalogClock.hourHandAngle(now),
                minute: ApAnalogClock.minuteHandAngle(now),
                second: ApAnalogClock.secondHandAngle(now)
            });
            window.requestAnimationFrame(_loop);
        }

        window.addEventListener('resize', s.resizeClock);
        _loop();
        s.resizeClock();
    },

    componentWillReceiveProps: function (nextProps) {
        let s = this;
    },

    componentWillUpdate: function (nextProps, nextState) {
        let s = this;
    },

    componentDidUpdate: function (prevProps, prevState) {
        let s = this;
    },

    componentWillUnmount: function () {
        let s = this;
        window.removeEventListener('resize', s.resizeClock);
        s._looping = false;
    },

    //------------------
    // Helper
    //------------------

    resizeClock: function () {
        let s = this,
            elm = ReactDOM.findDOMNode(s);
        let size = numcal.min(elm.offsetWidth, elm.offsetHeight);
        s.setState({
            size: size
        });
    }
    //------------------
    // Private
    //------------------
});

module.exports = ApAnalogClock;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImpzeC9hcF9hbmFsb2dfY2xvY2suanN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBS0EsWUFBWSxDQUFDOztBQUViLE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUM7TUFDMUIsUUFBUSxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUM7TUFDL0IsVUFBVSxHQUFHLE9BQU8sQ0FBQyxZQUFZLENBQUM7TUFDbEMsT0FBTyxHQUFHLE9BQU8sQ0FBQyxZQUFZLENBQUM7TUFDL0IsZUFBZSxHQUFHLE9BQU8sQ0FBQyxnQ0FBZ0MsQ0FBQztNQUMzRCxPQUFPLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQztNQUM1QixNQUFNLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQztNQUMxQixLQUFLLEdBQUcsS0FBSyxDQUFDLFNBQVM7TUFDdkIsaUJBQWlCLEdBQUcsT0FBTyxDQUFDLHdCQUF3QixDQUFDO01BQ3JELG1CQUFtQixHQUFHLE9BQU8sQ0FBQywwQkFBMEIsQ0FBQzs7O0FBQUMsQUFHOUQsSUFBSSxhQUFhLEdBQUcsS0FBSyxDQUFDLFdBQVcsQ0FBQzs7Ozs7OztBQU1sQyxhQUFTLEVBQUU7QUFDUCxvQkFBWSxFQUFFLEtBQUssQ0FBQyxLQUFLO0tBQzVCOztBQUVELFVBQU0sRUFBRSxDQUNKLGVBQWUsQ0FDbEI7O0FBRUQsV0FBTyxFQUFFO0FBQ0wsc0JBQWMsRUFBRSxVQUFVLEtBQUssRUFBRSxHQUFHLEVBQUU7QUFDbEMsZ0JBQUksSUFBSSxHQUFHLEFBQUMsS0FBSyxHQUFHLEdBQUcsR0FBSSxHQUFHLENBQUM7QUFDL0IsbUJBQU8sT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLEdBQUcsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1NBQ3pDO0FBQ0QscUJBQWEsRUFBRSxVQUFVLElBQUksRUFBRTtBQUMzQixnQkFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO0FBQzVCLG1CQUFPLGFBQWEsQ0FBQyxjQUFjLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1NBQ2xEO0FBQ0QsdUJBQWUsRUFBRSxVQUFVLElBQUksRUFBRTtBQUM3QixnQkFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO0FBQ2hDLG1CQUFPLGFBQWEsQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1NBQ3BEO0FBQ0QsdUJBQWUsRUFBRSxVQUFVLElBQUksRUFBRTtBQUM3QixnQkFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO0FBQ2hDLG1CQUFPLGFBQWEsQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1NBQ3BEO0FBQ0QsbUJBQVcsRUFBRSxVQUFVLENBQUMsRUFBRSxLQUFLLEVBQUU7QUFDN0IsbUJBQU8sYUFBYSxDQUFDLGNBQWMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDakQ7S0FDSjs7QUFFRCxtQkFBZSxFQUFFLFlBQVk7QUFDekIsZUFBTztBQUNILGdCQUFJLEVBQUUsQ0FBQztBQUNQLGtCQUFNLEVBQUUsQ0FBQztBQUNULGtCQUFNLEVBQUUsQ0FBQztBQUNULGdCQUFJLEVBQUUsR0FBRztTQUNaLENBQUM7S0FDTDs7QUFFRCxtQkFBZSxFQUFFLFlBQVk7QUFDekIsZUFBTztBQUNILHdCQUFZLEVBQUUsNEJBQTRCLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQztTQUN4RCxDQUFDO0tBQ0w7O0FBRUQsVUFBTSxFQUFFLFlBQVk7QUFDaEIsWUFBSSxDQUFDLEdBQUcsSUFBSTtZQUNSLEtBQUssR0FBRyxDQUFDLENBQUMsS0FBSztZQUNmLEtBQUssR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDOztBQUVwQixZQUFJLE9BQU8sR0FBRyxLQUFLLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsT0FBTyxLQUFJO0FBQ3hELGdCQUFJLEtBQUssR0FBRyxhQUFhLENBQUMsV0FBVyxDQUFDLENBQUMsRUFBRSxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDekQsbUJBQ0ksb0JBQUMsbUJBQW1CLElBQUMsR0FBRyxFQUFFLG1CQUFtQixHQUFHLENBQUMsQUFBQztBQUM3QixzQkFBTSxFQUFFLE1BQU0sQUFBQztBQUNmLHFCQUFLLEVBQUUsS0FBSyxBQUFDLEdBQXVCLENBQzNEO1NBQ0wsQ0FBQyxDQUFDOztBQUVILFlBQUksSUFBSSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUM7O0FBRXRCLFlBQUksVUFBVSxHQUFHO0FBQ2IsaUJBQUssRUFBRSxJQUFJO0FBQ1gsa0JBQU0sRUFBRSxJQUFJO1NBQ2YsQ0FBQzs7QUFFRixZQUFJLFNBQVMsR0FBRyxDQUFDLENBQUM7O0FBRWxCLGVBQ0k7QUFBQyxtQkFBTztjQUFDLFNBQVMsRUFBRSxVQUFVLENBQUMsaUJBQWlCLEVBQUUsS0FBSyxDQUFDLFNBQVMsQ0FBQyxBQUFDO1lBQy9EOztrQkFBSyxTQUFTLEVBQUMsdUJBQXVCLEVBQUMsS0FBSyxFQUFFLFVBQVUsQUFBQztnQkFDckQ7O3NCQUFLLFNBQVMsRUFBQyw2QkFBNkI7b0JBQ3hDLG9CQUFDLGlCQUFpQixJQUFDLFNBQVMsRUFBQywyQkFBMkIsRUFBQyxLQUFLLEVBQUUsQ0FBQyxBQUFDLEVBQUMsVUFBVSxFQUFFLEdBQUcsQUFBQztBQUNoRSw2QkFBSyxFQUFFLEtBQUssQ0FBQyxJQUFJLEFBQUMsR0FBcUI7b0JBQzFELG9CQUFDLGlCQUFpQixJQUFDLFNBQVMsRUFBQyw2QkFBNkIsRUFBQyxLQUFLLEVBQUUsQ0FBQyxBQUFDLEVBQUMsVUFBVSxFQUFFLElBQUksQUFBQztBQUNuRSw2QkFBSyxFQUFFLEtBQUssQ0FBQyxNQUFNLEFBQUMsR0FBcUI7b0JBQzVELG9CQUFDLGlCQUFpQixJQUFDLFNBQVMsRUFBQyw2QkFBNkIsRUFBQyxLQUFLLEVBQUUsQ0FBQyxBQUFDLEVBQUMsVUFBVSxFQUFFLENBQUMsQUFBQztBQUNoRSw2QkFBSyxFQUFFLEtBQUssQ0FBQyxNQUFNLEFBQUMsR0FBcUI7aUJBQzFEO2dCQUNOOzs7b0JBQ0ssT0FBTztpQkFDTjtnQkFDTjs7c0JBQUssU0FBUyxFQUFDLGlDQUFpQztvQkFDNUMsNkJBQUssU0FBUyxFQUFDLHVCQUF1QjtBQUNqQyw2QkFBSyxFQUFFLEVBQUMsS0FBSyxFQUFDLFNBQVMsRUFBRSxNQUFNLEVBQUMsU0FBUyxFQUFFLE1BQU0sRUFBQyxDQUFDLFNBQVMsR0FBQyxDQUFDLEVBQUMsQUFBQztBQUNoRSwyQkFBRyxFQUFDLE9BQU8sR0FBTztpQkFDckI7YUFDSjtTQUNBLENBQ1o7S0FDTDs7Ozs7O0FBT0Qsc0JBQWtCLEVBQUUsWUFBWTtBQUM1QixZQUFJLENBQUMsR0FBRyxJQUFJLENBQUM7QUFDYixTQUFDLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztLQUNyQjs7QUFFRCxxQkFBaUIsRUFBRSxZQUFZO0FBQzNCLFlBQUksQ0FBQyxHQUFHLElBQUk7WUFDUixLQUFLLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQzs7QUFFcEIsaUJBQVMsS0FBSyxHQUFHO0FBQ2IsZ0JBQUksQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFO0FBQ2IsdUJBQU87YUFDVjtBQUNELGdCQUFJLEdBQUcsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO0FBQ3JCLGFBQUMsQ0FBQyxRQUFRLENBQUM7QUFDUCxvQkFBSSxFQUFFLGFBQWEsQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDO0FBQ3RDLHNCQUFNLEVBQUUsYUFBYSxDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUM7QUFDMUMsc0JBQU0sRUFBRSxhQUFhLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQzthQUM3QyxDQUFDLENBQUM7QUFDSCxrQkFBTSxDQUFDLHFCQUFxQixDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ3ZDOztBQUVELGNBQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0FBQ2pELGFBQUssRUFBRSxDQUFDO0FBQ1IsU0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO0tBQ25COztBQUVELDZCQUF5QixFQUFFLFVBQVUsU0FBUyxFQUFFO0FBQzVDLFlBQUksQ0FBQyxHQUFHLElBQUksQ0FBQztLQUNoQjs7QUFFRCx1QkFBbUIsRUFBRSxVQUFVLFNBQVMsRUFBRSxTQUFTLEVBQUU7QUFDakQsWUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDO0tBQ2hCOztBQUVELHNCQUFrQixFQUFFLFVBQVUsU0FBUyxFQUFFLFNBQVMsRUFBRTtBQUNoRCxZQUFJLENBQUMsR0FBRyxJQUFJLENBQUM7S0FDaEI7O0FBRUQsd0JBQW9CLEVBQUUsWUFBWTtBQUM5QixZQUFJLENBQUMsR0FBRyxJQUFJLENBQUM7QUFDYixjQUFNLENBQUMsbUJBQW1CLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUNwRCxTQUFDLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQztLQUN0Qjs7Ozs7O0FBTUQsZUFBVyxFQUFFLFlBQVk7QUFDckIsWUFBSSxDQUFDLEdBQUcsSUFBSTtZQUNSLEdBQUcsR0FBRyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ2xDLFlBQUksSUFBSSxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDekQsU0FBQyxDQUFDLFFBQVEsQ0FBQztBQUNQLGdCQUFJLEVBQUUsSUFBSTtTQUNiLENBQUMsQ0FBQztLQUNOOzs7O0FBQUEsQ0FJSixDQUFDLENBQUM7O0FBRUgsTUFBTSxDQUFDLE9BQU8sR0FBRyxhQUFhLENBQUMiLCJmaWxlIjoiYXBfYW5hbG9nX2Nsb2NrLmpzIiwic291cmNlUm9vdCI6Ii9Vc2Vycy9va3VuaXNoaXRha2EvcHJvamVjdHMvYXBlbWFuLXJlYWN0LWxhYm8vYXBlbWFuLXJlYWN0LWNsb2NrL2xpYi9qc3giLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEFuYWxvZyBjbG9jay5cbiAqIEBjb25zdHJ1Y3RvciBBcEFuYWxvZ0Nsb2NrXG4gKi9cblxuXCJ1c2Ugc3RyaWN0XCI7XG5cbmNvbnN0IFJlYWN0ID0gcmVxdWlyZSgncmVhY3QnKSxcbiAgICBSZWFjdERPTSA9IHJlcXVpcmUoJ3JlYWN0LWRvbScpLFxuICAgIGNsYXNzbmFtZXMgPSByZXF1aXJlKCdjbGFzc25hbWVzJyksXG4gICAgQXBDbG9jayA9IHJlcXVpcmUoJy4vYXBfY2xvY2snKSxcbiAgICBQdXJlUmVuZGVyTWl4aW4gPSByZXF1aXJlKCdyZWFjdC1hZGRvbnMtcHVyZS1yZW5kZXItbWl4aW4nKSxcbiAgICBjaG9wY2FsID0gcmVxdWlyZSgnY2hvcGNhbCcpLFxuICAgIG51bWNhbCA9IHJlcXVpcmUoJ251bWNhbCcpLFxuICAgIHR5cGVzID0gUmVhY3QuUHJvcFR5cGVzLFxuICAgIEFwQW5hbG9nQ2xvY2tIYW5kID0gcmVxdWlyZSgnLi9hcF9hbmFsb2dfY2xvY2tfaGFuZCcpLFxuICAgIEFwQW5hbG9nQ2xvY2tMZXR0ZXIgPSByZXF1aXJlKCcuL2FwX2FuYWxvZ19jbG9ja19sZXR0ZXInKTtcblxuLyoqIEBsZW5kcyBBcEFuYWxvZ0Nsb2NrICovXG5sZXQgQXBBbmFsb2dDbG9jayA9IFJlYWN0LmNyZWF0ZUNsYXNzKHtcblxuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAvLyBTcGVjc1xuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuICAgIHByb3BUeXBlczoge1xuICAgICAgICBib2FyZExldHRlcnM6IHR5cGVzLmFycmF5XG4gICAgfSxcblxuICAgIG1peGluczogW1xuICAgICAgICBQdXJlUmVuZGVyTWl4aW5cbiAgICBdLFxuXG4gICAgc3RhdGljczoge1xuICAgICAgICBfYW5nbGVGb3JWYWx1ZTogZnVuY3Rpb24gKHZhbHVlLCBtYXgpIHtcbiAgICAgICAgICAgIGxldCByYXRlID0gKHZhbHVlICUgbWF4KSAvIG1heDtcbiAgICAgICAgICAgIHJldHVybiBjaG9wY2FsLnJvdW5kKHJhdGUgKiAzNjAsIDAuMSk7XG4gICAgICAgIH0sXG4gICAgICAgIGhvdXJIYW5kQW5nbGU6IGZ1bmN0aW9uIChkYXRlKSB7XG4gICAgICAgICAgICBsZXQgaG91cnMgPSBkYXRlLmdldEhvdXJzKCk7XG4gICAgICAgICAgICByZXR1cm4gQXBBbmFsb2dDbG9jay5fYW5nbGVGb3JWYWx1ZShob3VycywgMTIpO1xuICAgICAgICB9LFxuICAgICAgICBtaW51dGVIYW5kQW5nbGU6IGZ1bmN0aW9uIChkYXRlKSB7XG4gICAgICAgICAgICBsZXQgbWludXRlcyA9IGRhdGUuZ2V0TWludXRlcygpO1xuICAgICAgICAgICAgcmV0dXJuIEFwQW5hbG9nQ2xvY2suX2FuZ2xlRm9yVmFsdWUobWludXRlcywgNjApO1xuICAgICAgICB9LFxuICAgICAgICBzZWNvbmRIYW5kQW5nbGU6IGZ1bmN0aW9uIChkYXRlKSB7XG4gICAgICAgICAgICBsZXQgc2Vjb25kcyA9IGRhdGUuZ2V0U2Vjb25kcygpO1xuICAgICAgICAgICAgcmV0dXJuIEFwQW5hbG9nQ2xvY2suX2FuZ2xlRm9yVmFsdWUoc2Vjb25kcywgNjApO1xuICAgICAgICB9LFxuICAgICAgICBsZXR0ZXJBbmdsZTogZnVuY3Rpb24gKGksIGNvdW50KSB7XG4gICAgICAgICAgICByZXR1cm4gQXBBbmFsb2dDbG9jay5fYW5nbGVGb3JWYWx1ZShpLCBjb3VudCk7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgZ2V0SW5pdGlhbFN0YXRlOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBob3VyOiAwLFxuICAgICAgICAgICAgbWludXRlOiAwLFxuICAgICAgICAgICAgc2Vjb25kOiAwLFxuICAgICAgICAgICAgc2l6ZTogMjU2XG4gICAgICAgIH07XG4gICAgfSxcblxuICAgIGdldERlZmF1bHRQcm9wczogZnVuY3Rpb24gKCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgYm9hcmRMZXR0ZXJzOiAnMTIsMSwyLDMsNCw1LDYsNyw4LDksMTAsMTEnLnNwbGl0KCcsJylcbiAgICAgICAgfTtcbiAgICB9LFxuXG4gICAgcmVuZGVyOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGxldCBzID0gdGhpcyxcbiAgICAgICAgICAgIHN0YXRlID0gcy5zdGF0ZSxcbiAgICAgICAgICAgIHByb3BzID0gcy5wcm9wcztcblxuICAgICAgICBsZXQgbGV0dGVycyA9IHByb3BzLmJvYXJkTGV0dGVycy5tYXAoKGxldHRlciwgaSwgbGV0dGVycyk9PiB7XG4gICAgICAgICAgICBsZXQgYW5nbGUgPSBBcEFuYWxvZ0Nsb2NrLmxldHRlckFuZ2xlKGksIGxldHRlcnMubGVuZ3RoKTtcbiAgICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAgICAgPEFwQW5hbG9nQ2xvY2tMZXR0ZXIga2V5PXtcImFwLWFuYWxvZy1sZXR0ZXItXCIgKyBpfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldHRlcj17bGV0dGVyfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFuZ2xlPXthbmdsZX0+PC9BcEFuYWxvZ0Nsb2NrTGV0dGVyPlxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgbGV0IHNpemUgPSBzdGF0ZS5zaXplO1xuXG4gICAgICAgIGxldCBib2FyZFN0eWxlID0ge1xuICAgICAgICAgICAgd2lkdGg6IHNpemUsXG4gICAgICAgICAgICBoZWlnaHQ6IHNpemVcbiAgICAgICAgfTtcblxuICAgICAgICBsZXQgc2NyZXdTaXplID0gOTtcblxuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPEFwQ2xvY2sgY2xhc3NOYW1lPXtjbGFzc25hbWVzKFwiYXAtYW5hbG9nLWNsb2NrXCIsIHByb3BzLmNsYXNzTmFtZSl9PlxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwiYXAtYW5hbG9nLWNsb2NrLWJvYXJkXCIgc3R5bGU9e2JvYXJkU3R5bGV9PlxuICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cImFwLWFuYWxvZy1jbG9jay1ib2FyZC1pbm5lclwiPlxuICAgICAgICAgICAgICAgICAgICAgICAgPEFwQW5hbG9nQ2xvY2tIYW5kIGNsYXNzTmFtZT1cImFwLWFuYWxvZy1jbG9jay1oYW5kLWhvdXJcIiB3aWR0aD17NH0gaGVpZ2h0UmF0ZT17MC44fVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFuZ2xlPXtzdGF0ZS5ob3VyfT48L0FwQW5hbG9nQ2xvY2tIYW5kPlxuICAgICAgICAgICAgICAgICAgICAgICAgPEFwQW5hbG9nQ2xvY2tIYW5kIGNsYXNzTmFtZT1cImFwLWFuYWxvZy1jbG9jay1oYW5kLW1pbnV0ZVwiIHdpZHRoPXs0fSBoZWlnaHRSYXRlPXswLjk1fVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFuZ2xlPXtzdGF0ZS5taW51dGV9PjwvQXBBbmFsb2dDbG9ja0hhbmQ+XG4gICAgICAgICAgICAgICAgICAgICAgICA8QXBBbmFsb2dDbG9ja0hhbmQgY2xhc3NOYW1lPVwiYXAtYW5hbG9nLWNsb2NrLWhhbmQtc2Vjb25kXCIgd2lkdGg9ezJ9IGhlaWdodFJhdGU9ezF9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5nbGU9e3N0YXRlLnNlY29uZH0+PC9BcEFuYWxvZ0Nsb2NrSGFuZD5cbiAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgICAgIDxkaXY+XG4gICAgICAgICAgICAgICAgICAgICAgICB7bGV0dGVyc31cbiAgICAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwiYXAtYW5hbG9nLWNsb2NrLXNjcmV3LWNvbnRhaW5lclwiPlxuICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJhcC1hbmFsb2ctY2xvY2stc2NyZXdcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHlsZT17e3dpZHRoOnNjcmV3U2l6ZSwgaGVpZ2h0OnNjcmV3U2l6ZSwgYm90dG9tOi1zY3Jld1NpemUvMn19XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZj1cInNjcmV3XCI+PC9kaXY+XG4gICAgICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgPC9BcENsb2NrPlxuICAgICAgICApO1xuICAgIH0sXG5cblxuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAvLyBMaWZlY3ljbGVcbiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbiAgICBjb21wb25lbnRXaWxsTW91bnQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgbGV0IHMgPSB0aGlzO1xuICAgICAgICBzLl9sb29waW5nID0gdHJ1ZTtcbiAgICB9LFxuXG4gICAgY29tcG9uZW50RGlkTW91bnQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgbGV0IHMgPSB0aGlzLFxuICAgICAgICAgICAgcHJvcHMgPSBzLnByb3BzO1xuXG4gICAgICAgIGZ1bmN0aW9uIF9sb29wKCkge1xuICAgICAgICAgICAgaWYgKCFzLl9sb29waW5nKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbGV0IG5vdyA9IG5ldyBEYXRlKCk7XG4gICAgICAgICAgICBzLnNldFN0YXRlKHtcbiAgICAgICAgICAgICAgICBob3VyOiBBcEFuYWxvZ0Nsb2NrLmhvdXJIYW5kQW5nbGUobm93KSxcbiAgICAgICAgICAgICAgICBtaW51dGU6IEFwQW5hbG9nQ2xvY2subWludXRlSGFuZEFuZ2xlKG5vdyksXG4gICAgICAgICAgICAgICAgc2Vjb25kOiBBcEFuYWxvZ0Nsb2NrLnNlY29uZEhhbmRBbmdsZShub3cpXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoX2xvb3ApO1xuICAgICAgICB9XG5cbiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIHMucmVzaXplQ2xvY2spO1xuICAgICAgICBfbG9vcCgpO1xuICAgICAgICBzLnJlc2l6ZUNsb2NrKCk7XG4gICAgfSxcblxuICAgIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHM6IGZ1bmN0aW9uIChuZXh0UHJvcHMpIHtcbiAgICAgICAgbGV0IHMgPSB0aGlzO1xuICAgIH0sXG5cbiAgICBjb21wb25lbnRXaWxsVXBkYXRlOiBmdW5jdGlvbiAobmV4dFByb3BzLCBuZXh0U3RhdGUpIHtcbiAgICAgICAgbGV0IHMgPSB0aGlzO1xuICAgIH0sXG5cbiAgICBjb21wb25lbnREaWRVcGRhdGU6IGZ1bmN0aW9uIChwcmV2UHJvcHMsIHByZXZTdGF0ZSkge1xuICAgICAgICBsZXQgcyA9IHRoaXM7XG4gICAgfSxcblxuICAgIGNvbXBvbmVudFdpbGxVbm1vdW50OiBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGxldCBzID0gdGhpcztcbiAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIHMucmVzaXplQ2xvY2spO1xuICAgICAgICBzLl9sb29waW5nID0gZmFsc2U7XG4gICAgfSxcblxuICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgLy8gSGVscGVyXG4gICAgLy8tLS0tLS0tLS0tLS0tLS0tLS1cblxuICAgIHJlc2l6ZUNsb2NrOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGxldCBzID0gdGhpcyxcbiAgICAgICAgICAgIGVsbSA9IFJlYWN0RE9NLmZpbmRET01Ob2RlKHMpO1xuICAgICAgICBsZXQgc2l6ZSA9IG51bWNhbC5taW4oZWxtLm9mZnNldFdpZHRoLCBlbG0ub2Zmc2V0SGVpZ2h0KTtcbiAgICAgICAgcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgICBzaXplOiBzaXplXG4gICAgICAgIH0pO1xuICAgIH1cbiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIC8vIFByaXZhdGVcbiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLVxufSk7XG5cbm1vZHVsZS5leHBvcnRzID0gQXBBbmFsb2dDbG9jaztcbiJdfQ==